// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String     @id @default(cuid())
  email         String     @unique
  firstName     String?
  lastName      String?
  password      String
  picture       String?
  plan          String     @default("free") // 'free' | 'pro'
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  proposals     Proposal[]
  invoices      Invoice[]
}

model Proposal {
  id                 String   @id @default(cuid())
  userId             String
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  clientName         String
  clientEmail        String
  clientCompany      String?
  projectTitle       String
  projectDescription String
  budget             String
  timeline           String
  currency           String   @default("USD")
  startDate          String?
  deliverables       String?
  status             String   @default("draft")
  createdAt          DateTime @default(now())

  // AI-generated content fields
  executiveSummary    String
  scopeOfWork         String
  pricingBreakdown    String
  timelineDetails     String
  termsAndConditions  String

  // Digital signature fields
  freelancerSignatureType String?  // 'drawn' | 'typed'
  freelancerSignatureData String? // Base64 image (drawn) or text (typed)
  freelancerSignedAt     DateTime?

  clientSignatureType String?
  clientSignatureData String?
  clientSignedAt     DateTime?

  signatureStatus String  @default("not_started") // 'not_started' | 'pending_client' | 'signed'
  signatureToken String? // Unique token for client verification

  // Security fields
  verificationCode      String?  // 6-digit code for email verification
  verificationCodeExpiry DateTime? // Code expires after 1 hour
  clientEmailVerified   Boolean  @default(false) // Has client verified email?
  contentHash           String?  // SHA-256 hash of proposal content
  termsAccepted         Boolean  @default(false) // Client accepted terms?
  ipAddress             String?  // Client IP for audit trail
  userAgent             String?  // Client browser/device info

  // Share link fields
  accessToken           String?  @unique  // Secure token for public sharing
  accessExpiresAt       DateTime? // Share link expiration (optional)

  // Invoice relation
  invoice               Invoice?
}

model Invoice {
  id                 String   @id @default(cuid())
  userId             String
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  proposalId         String   @unique
  proposal           Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)

  // Client information
  clientName         String
  clientEmail        String
  clientCompany      String?

  // Invoice details
  invoiceNumber      String   @unique // Auto-generated: INV-0001, INV-0002, etc.
  issueDate          DateTime @default(now())
  dueDate            DateTime // Payment due date
  status             String   @default("UNPAID") // 'UNPAID' | 'PARTIALLY_PAID' | 'PAID' | 'OVERDUE' | 'CANCELLED'

  // Payment information
  subtotal           Float    // Sum of all line items
  taxRate            Float    @default(0) // Tax percentage (e.g., 10 for 10%)
  taxAmount          Float    @default(0)
  total              Float    // subtotal + taxAmount

  // Payment tracking
  currency           String   @default("USD")
  paymentLink        String?  // Dodo Payments checkout link
  paidAmount         Float    @default(0) // Total amount paid so far (supports partial payments)
  remainingAmount    Float    @default(0) // Total - paidAmount (computed)

  // Line items (JSON string)
  lineItems          String   // JSON array of items: [{description, quantity, rate, amount}]

  // Additional details
  notes              String?
  terms              String?

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Relations
  payments           Payment[]

  // Reminders
  reminderSent       Boolean  @default(false)
  reminderCount      Int      @default(0)
  lastReminderAt     DateTime?

  // Share link fields
  accessToken           String?  @unique  // Secure token for public sharing
  accessExpiresAt       DateTime? // Share link expiration (optional)
}

model Payment {
  id                 String   @id @default(cuid())
  invoiceId          String
  invoice            Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  // Payment details from Dodo Payments
  externalPaymentId  String   @unique // Dodo Payments payment/session ID
  amount             Float    // Amount paid in this transaction
  currency           String   @default("USD")

  // Payment status
  status             String   @default("succeeded") // 'succeeded' | 'pending' | 'failed' | 'refunded'

  // Metadata
  paymentMethod      String?  // e.g., 'card', 'upi'
  metadata           String?  // JSON string for additional data

  // Timestamps
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}
